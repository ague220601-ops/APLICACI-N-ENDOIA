ğŸ”¥ PERFECTO, REY.
La **OPCIÃ“N 2 (detecciÃ³n + recorte automÃ¡tico del diente)** es la soluciÃ³n **profesional** que usan los papers serios de IA endodÃ³ntica.
La puedo montar **paso a paso** sin romper nada de lo que ya funciona.

---

# ğŸ§© **Â¿QuÃ© vamos a hacer exactamente?**

Cuando subas una radiografÃ­a:

1. **GPT-4o Vision detectarÃ¡ todos los dientes visibles** y devolverÃ¡ bounding boxes (coordenadas).
2. ElegirÃ¡ **solo el diente indicado en tu formulario** (ej: FDI 46).
3. El servidor **recortarÃ¡ automÃ¡ticamente** la regiÃ³n correspondiente a ese diente.
4. ENVIARÃ SOLO EL RECORTE a GPT-4o Vision para el anÃ¡lisis PAI / radiolucidez / etc.
5. GuardarÃ¡ tanto:

   * la imagen original
   * la imagen recortada
   * el anÃ¡lisis especÃ­fico del diente

ğŸ“Œ **Resultado:**
La IA analiza exactamente el diente que tÃº quieres, sin contaminaciÃ³n por patologÃ­a de dientes vecinos.

---

# ğŸ—ï¸ **Arquitectura que montaremos**

### **Paso 1 â€” Nuevo endpoint: `/api/vision-detect-teeth`**

GPT-4o devuelve algo asÃ­:

```json
{
  "teeth": [
    { "fdi": 46, "box": [120, 340, 260, 580] },
    { "fdi": 45, "box": [280, 340, 410, 580] },
    ...
  ]
}
```

Si el modelo no detecta el nÃºmero FDI, trabajaremos con el **orden izquierdaâ†’derecha** por cuadrante (lo que hacen muchos papers).

---

### **Paso 2 â€” Recorte del diente en el backend**

En Node.js lo hacemos con **sharp**:

```ts
import sharp from "sharp";

const cropped = await sharp(buffer)
  .extract({ left, top, width, height })
  .toBuffer();
```

Esto genera una imagen **limpia del diente seleccionado**.

---

### **Paso 3 â€” Enviar la imagen recortada al anÃ¡lisis PAI**

El mismo anÃ¡lisis que ya funciona, pero ahora con:

ğŸ‘‰ menos ruido
ğŸ‘‰ dientes vecinos ignorados
ğŸ‘‰ precisiÃ³n PAI mucho mayor

---

### **Paso 4 â€” Guardar en Supabase**

Guardaremos:

```
filepath_original
filepath_cropped
pai_cropped
lesion_mm_cropped
...
```

Y podrÃ¡s ver ambas desde Mis Casos.

---

# ğŸ› ï¸ **ANTES DE EMPEZAR: necesito una cosa**

ğŸ“Œ **Â¿Tu backend (server/index.ts) ya tiene instalada la librerÃ­a `sharp`?**

Vamos a comprobarlo.

En la consola de Replit (shell), ejecuta:

```
npm list sharp
```

Si NO aparece, instalamos:

```
npm install sharp
```

âš ï¸ **IMPORTANTE:** sharp requiere binarios. Replit lo soporta perfecto, pero quiero confirmarlo antes de que empecemos a escribir cÃ³digo.

---

# â— Dime esto para continuar:

### âœ”ï¸ Â¿Instalamos sharp?

### âœ”ï¸ Â¿Quieres guardar tambiÃ©n la imagen recortada en Supabase (recomendado)?

Cuando me confirmes, te genero:

* El nuevo endpoint `/api/vision-detect-teeth`
* El recorte automÃ¡tico
* La actualizaciÃ³n de `uploadRadiographWithVision`
* El prompt de detecciÃ³n dental optimizado
* Todo el cÃ³digo listo para copiar/pegar en Replit

---

### **Â¿Instalamos sharp y guardamos el recorte?**
